<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MAL Portrait Widget</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">

<style>
*, *::before, *::after { box-sizing: border-box; }

body {
  background: #0b0b0b;
  display: flex;
  justify-content: center;
  padding: 40px;
  font-family: 'Noto Sans JP', sans-serif;
}

/* ===================== WIDGET SHELL ===================== */
.mal-widget {
  background: #111;
  color: #ddd;
  width: 420px;
  padding: 20px;
  border: 2px solid #2db039;   /* default = manga = green */
  transition: border-color 0.5s ease;
  position: relative;
}

.mal-widget.anime-mode { border-color: #2e51a2; }  /* anime = blue */

/* ===================== HEADER ===================== */
.mal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid #2a2a2a;
  padding-bottom: 12px;
  margin-bottom: 16px;
}

/* Username — LEFT */
.mal-username {
  font-family: 'Rajdhani', sans-serif;
  font-size: 22px;
  font-weight: 700;
  color: #2db039;
  letter-spacing: 0.04em;
  transition: color 0.3s ease;
  margin: 0;
  line-height: 1;
  cursor: pointer;
}

.mal-username:hover { color: #fff; }

.mal-widget.anime-mode .mal-username       { color: #2e51a2; }
.mal-widget.anime-mode .mal-username:hover { color: #fff; }

/* Toggle — RIGHT, smaller */
.mode-switch {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 10px;
  color: #888;
  font-family: 'Rajdhani', sans-serif;
  font-weight: 600;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  flex-shrink: 0;
}

.mode-switch input { display: none; }

.slider {
  width: 30px;
  height: 16px;
  background: #2db039;         /* unchecked = manga = green */
  border-radius: 16px;
  position: relative;
  cursor: pointer;
  transition: background 0.4s ease;
  flex-shrink: 0;
}

.slider::before {
  content: "";
  width: 11px;
  height: 11px;
  background: #fff;
  position: absolute;
  top: 2.5px;
  left: 2.5px;
  border-radius: 50%;
  transition: transform 0.3s ease;
}

input:checked + .slider { background: #2e51a2; }  /* checked = anime = blue */
input:checked + .slider::before { transform: translateX(14px); }

/* Toggle label colors — controlled by .anime-mode on the widget */
.label-manga { color: #2db039; transition: color 0.4s ease; }  /* manga mode: manga=green */
.label-anime  { color: #555;   transition: color 0.4s ease; }  /* manga mode: anime=grey */

.mal-widget.anime-mode .label-manga { color: #555; }            /* anime mode: manga=grey */
.mal-widget.anime-mode .label-anime  { color: #2e51a2; }        /* anime mode: anime=blue */

/* ===================== STATS SUMMARY ===================== */
.stats-summary {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
  font-size: 13px;
  color: #aaa;
  font-family: 'Rajdhani', sans-serif;
  font-weight: 500;
  letter-spacing: 0.03em;
}

.stats-summary span {
  color: #ddd;
  font-weight: 700;
  font-size: 14px;
}

/* ===================== SECTION LABEL ===================== */
.section-label {
  font-family: 'Rajdhani', sans-serif;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: #555;
  margin-bottom: 8px;
}

/* ===================== STAT BAR ===================== */
.stats-bar {
  display: flex;
  height: 6px;
  border-radius: 3px;
  overflow: hidden;
  background: #1e1e1e;
  margin-bottom: 14px;
  gap: 1px;
}

.bar {
  height: 100%;
  width: 0%;
  transition: width 0.9s cubic-bezier(0.22, 1, 0.36, 1);
  border-radius: 2px;
}

.bar.watching   { background: #2db039; }
.bar.completed  { background: #26448f; }
.bar.onhold     { background: #c3a300; }
.bar.dropped    { background: #a12f31; }
.bar.plan       { background: #444; }

/* ===================== STATS GRID ===================== */
/* white-space: nowrap prevents 4-digit numbers from wrapping to a second line */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 5px 10px;
  font-size: 12px;
  color: #888;
  font-family: 'Rajdhani', sans-serif;
  font-weight: 500;
  letter-spacing: 0.03em;
  margin-bottom: 4px;
}

.stats-grid > div {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.stats-grid .stat-val {
  color: #ccc;
  font-weight: 700;
}

/* Legend dots */
.dot {
  display: inline-block;
  width: 7px;
  height: 7px;
  border-radius: 50%;
  margin-right: 5px;
  vertical-align: middle;
}

.dot.watching  { background: #2db039; }
.dot.completed { background: #26448f; }
.dot.onhold    { background: #c3a300; }
.dot.dropped   { background: #a12f31; }
.dot.plan      { background: #444; }

/* Extra stats row (volumes/chapters for manga, episodes for anime) */
.extra-stats {
  display: flex;
  gap: 20px;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #1e1e1e;
  font-size: 12px;
  font-family: 'Rajdhani', sans-serif;
  color: #888;
  white-space: nowrap;
}

.extra-stats .stat-val { color: #ccc; font-weight: 700; }

/* ===================== DIVIDER ===================== */
.divider {
  border: none;
  border-top: 1px solid #1e1e1e;
  margin: 16px 0;
}

/* ===================== RECENT UPDATE ===================== */
.section-header {
  font-family: 'Rajdhani', sans-serif;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: #555;
  margin-bottom: 10px;
}

.update-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.update-item {
  display: flex;
  gap: 10px;
  align-items: flex-start;
}

.update-item img {
  width: 48px;
  height: 68px;
  object-fit: cover;
  border-radius: 3px;
  flex-shrink: 0;
  border: 1px solid #222;
}

.update-info {
  flex: 1;
  min-width: 0;
}

.update-title {
  font-size: 13px;
  font-family: 'Rajdhani', sans-serif;
  font-weight: 600;
  color: #ddd;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 4px;
}

.update-title a {
  color: inherit;
  text-decoration: none;
}

.update-title a:hover { color: #2db039; }                                  /* manga = green */
.mal-widget.anime-mode .update-title a:hover { color: #2e51a2; }           /* anime = blue */

.update-meta {
  font-size: 11px;
  color: #666;
  font-family: 'Rajdhani', sans-serif;
  margin-bottom: 6px;
}

.progress-track {
  height: 4px;
  background: #1e1e1e;
  border-radius: 2px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: #2db039;         /* default = manga = green */
  border-radius: 2px;
  width: 0%;
  transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
}

.mal-widget.anime-mode .progress-fill { background: #2e51a2; }  /* anime = blue */

/* ===================== FAVORITES CAROUSEL ===================== */
/* Renders exactly 3 items at a time (prev / center / next).
   DOM is rebuilt on each advance — no translateX, no clone math. */
.mal-carousel {
  margin-top: 25px;
  border-top: 1px solid #333;
  padding-top: 16px;
  display: flex;
  flex-direction: column;  /* label on top, window below */
}

.carousel-window {
  width: 100%;
  height: 260px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #1a1a1a;
}

.carousel-track {
  display: flex;
  align-items: center;
}

.carousel-item {
  margin: 0 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100px;
  flex-shrink: 0;
}

.image-wrapper {
  height: 210px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  z-index: 1;
}

.carousel-item img {
  width: 100px;
  transition: transform 0.6s ease, opacity 0.6s ease, filter 0.6s ease;
  opacity: 0.8;
  border: 2px solid #2db039;   /* default = manga = green */
  transform: scale(0.9);
  filter: blur(1px);
  border-radius: 6px;
  cursor: pointer;
}

.mal-widget.anime-mode .carousel-item img { border-color: #2e51a2; }  /* anime = blue */

.carousel-item.center img {
  transform: scale(1.35);
  opacity: 1;
  filter: blur(0);
  box-shadow:
    0 0 0 1px rgba(45,176,57,0.4),   /* manga = green glow */
    0 25px 45px rgba(0,0,0,0.7);
}

.mal-widget.anime-mode .carousel-item.center img {
  box-shadow:
    0 0 0 1px rgba(46,81,162,0.4),   /* anime = blue glow */
    0 25px 45px rgba(0,0,0,0.7);
}

/* 2-line clamped title — wider than the image so longer names breathe */
.item-title {
  font-size: 11px;
  color: #888;
  opacity: 0;
  margin-top: 6px;
  width: 130px;
  text-align: center;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  line-height: 1.35;
  padding-bottom: 3px;
  position: relative;
  z-index: 3;
}

.carousel-item.center .item-title {
  opacity: 1;
  color: #2db039;
  font-weight: bold;
  cursor: pointer;
  transition: color 0.3s ease;
}

.carousel-item.center .item-title:hover { color: #fff; }

.mal-widget.anime-mode .carousel-item.center .item-title       { color: #2e51a2; }
.mal-widget.anime-mode .carousel-item.center .item-title:hover { color: #fff; }

/* ===================== FADE TRANSITION ===================== */
.content-fade {
  transition: opacity 0.2s ease;
}

.content-fade.fading { opacity: 0; }
</style>
</head>

<body>
<div class="mal-widget" id="widget">

  <!-- HEADER: username LEFT, toggle RIGHT -->
  <div class="mal-header">
    <h2 class="mal-username" id="mal-username">—</h2>
    <label class="mode-switch">
      <span class="label-manga">Manga</span>
      <input type="checkbox" id="modeToggle">
      <span class="slider"></span>
      <span class="label-anime">Anime</span>
    </label>
  </div>

  <!-- STATS SECTION -->
  <div class="content-fade" id="stats-section">

    <div class="stats-summary">
      <div>Total Days &nbsp;<span id="days">—</span></div>
      <div>Mean Score &nbsp;<span id="mean">—</span></div>
    </div>

    <div class="section-label" id="stats-label">Manga Stats</div>

    <div class="stats-bar">
      <div class="bar watching"  id="bar-watching"></div>
      <div class="bar completed" id="bar-completed"></div>
      <div class="bar onhold"    id="bar-onhold"></div>
      <div class="bar dropped"   id="bar-dropped"></div>
      <div class="bar plan"      id="bar-plan"></div>
    </div>

    <div class="stats-grid">
      <!-- Row 1 -->
      <div><span class="dot watching"></span><span id="label-watching">Watching</span> <span class="stat-val" id="stat-watching">—</span></div>
      <div>Total Entries <span class="stat-val" id="stat-total">—</span></div>
      <!-- Row 2 -->
      <div><span class="dot completed"></span>Completed <span class="stat-val" id="stat-completed">—</span></div>
      <div id="rewatch-row">Rewatched <span class="stat-val" id="stat-rewatch">—</span></div>
      <!-- Row 3 -->
      <div><span class="dot onhold"></span>On-Hold <span class="stat-val" id="stat-onhold">—</span></div>
      <div id="extra-episodes">Episodes <span class="stat-val" id="stat-episodes">—</span></div>
      <div id="extra-chapters" style="display:none">Chapters <span class="stat-val" id="stat-chapters">—</span></div>
      <!-- Row 4 -->
      <div><span class="dot dropped"></span>Dropped <span class="stat-val" id="stat-dropped">—</span></div>
      <div id="extra-volumes" style="display:none">Volumes <span class="stat-val" id="stat-volumes">—</span></div>
      <div id="extra-volumes-placeholder"></div>
      <!-- Row 5 -->
      <div><span class="dot plan"></span><span id="label-plan">Plan to Watch</span> <span class="stat-val" id="stat-plan">—</span></div>
      <div></div>
    </div>

  </div>

  <hr class="divider">

  <!-- RECENT UPDATES -->
  <div class="content-fade" id="updates-section">
    <div class="section-header" id="updates-label">Recent Manga Updates</div>
    <div class="update-list" id="update-list"></div>
  </div>

  <!-- FAVORITES CAROUSEL -->
  <div class="mal-carousel content-fade" id="carousel-section">
    <div class="section-header" id="carousel-label">Anime Favorites</div>
    <div class="carousel-window" id="carousel-window">
      <div class="carousel-track" id="carousel-track"></div>
    </div>
  </div>

</div>

<script>
(async () => {

  const API = "https://api.jikan.moe/v4/users/dream-state/full";

  const res  = await fetch(API);
  const json = await res.json();
  const data = json.data;

  const widget       = document.getElementById("widget");
  const toggle       = document.getElementById("modeToggle");
  const fadeSections = document.querySelectorAll(".content-fade");

  // USERNAME
  const usernameEl = document.getElementById("mal-username");
  usernameEl.textContent = data.username;
  usernameEl.onclick = () => window.open(data.url, "_blank");

  // ---- Stat bar animation ----
  function animateBars(stats, isAnime) {
    const total   = stats.total_entries || 1;
    const active  = isAnime ? stats.watching || 0 : stats.reading || 0;
    const planVal = isAnime ? stats.plan_to_watch || 0 : stats.plan_to_read || 0;

    function setBar(id, value) {
      const el = document.getElementById(id);
      el.style.width = "0%";
      requestAnimationFrame(() => requestAnimationFrame(() => {
        el.style.width = ((value / total) * 100) + "%";
      }));
    }

    setBar("bar-watching",  active);
    setBar("bar-completed", stats.completed || 0);
    setBar("bar-onhold",    stats.on_hold   || 0);
    setBar("bar-dropped",   stats.dropped   || 0);
    setBar("bar-plan",      planVal);
  }

  // ---- Render updates (JIKAN FORMAT) ----
  function renderUpdates(entries, isAnime) {
    const list = document.getElementById("update-list");
    list.innerHTML = "";

    entries.slice(0, 5).forEach(update => {

      const entry = update.entry;
      const image = entry.images?.jpg?.image_url || "";
      const title = entry.title;
      const url   = entry.url;

      let progress = 0;
      let total    = 0;
      let label    = "";

      if (isAnime) {
        progress = update.episodes_seen || 0;
        total    = update.episodes_total || 0;
        label    = `Ep ${progress} / ${total || "?"}`;
      } else {
        progress = update.chapters_read || 0;
        total    = update.chapters_total || 0;
        label    = `Ch ${progress} / ${total || "?"}`;
      }

      const pct = total ? Math.round((progress / total) * 100) : 0;

      const el = document.createElement("div");
      el.className = "update-item";
      el.innerHTML = `
        <img src="${image}" alt="${title}" loading="lazy">
        <div class="update-info">
          <div class="update-title">
            <a href="${url}" target="_blank">${title}</a>
          </div>
          <div class="update-meta">${label} · ${pct}%</div>
          <div class="progress-track">
            <div class="progress-fill" style="width:${pct}%"></div>
          </div>
        </div>
      `;
      list.appendChild(el);
    });
  }

  // ===================== CAROUSEL =====================
  let carouselFavs = [];
  let currentIndex = 0;
  let autoSlide    = null;

  function renderCarousel() {
    const track = document.getElementById("carousel-track");
    track.innerHTML = "";

    if (!carouselFavs.length) return;

    const n = carouselFavs.length;

    const visible = [
      carouselFavs[(currentIndex - 1 + n) % n],
      carouselFavs[currentIndex],
      carouselFavs[(currentIndex + 1) % n]
    ];

    visible.forEach((fav, i) => {

      const itemDiv = document.createElement("div");
      itemDiv.className = "carousel-item" + (i === 1 ? " center" : "");

      const img = document.createElement("img");
      img.src = fav.images?.jpg?.image_url || "";
      img.alt = fav.title;
      img.onclick = () => window.open(fav.url, "_blank");

      const title = document.createElement("div");
      title.className = "item-title";
      title.textContent = fav.title;
      title.onclick = () => window.open(fav.url, "_blank");

      const wrap = document.createElement("div");
      wrap.className = "image-wrapper";
      wrap.appendChild(img);

      itemDiv.appendChild(wrap);
      itemDiv.appendChild(title);
      track.appendChild(itemDiv);
    });
  }

  function nextSlide() {
    currentIndex = (currentIndex + 1) % carouselFavs.length;
    renderCarousel();
  }

  function buildCarousel(favorites) {
    clearInterval(autoSlide);
    carouselFavs = favorites;
    currentIndex = 0;

    if (!favorites.length) {
      document.getElementById("carousel-track").innerHTML = "";
      return;
    }

    renderCarousel();
    autoSlide = setInterval(nextSlide, 4000);
  }

  document.getElementById("carousel-window")
    .addEventListener("mouseenter", () => clearInterval(autoSlide));

  document.getElementById("carousel-window")
    .addEventListener("mouseleave", () => {
      if (carouselFavs.length)
        autoSlide = setInterval(nextSlide, 4000);
    });

  // ===================== MAIN RENDER =====================
  function render(mode) {

    const isAnime = mode === "anime";
    const stats   = isAnime ? data.statistics.anime : data.statistics.manga;

    fadeSections.forEach(el => el.classList.add("fading"));

    setTimeout(() => {

      widget.classList.toggle("anime-mode", isAnime);

      document.getElementById("stats-label").textContent =
        isAnime ? "Anime Stats" : "Manga Stats";

      document.getElementById("mean").textContent =
        stats.mean_score ?? "—";

      document.getElementById("days").textContent =
        isAnime ? stats.days_watched ?? "—"
                : stats.days_read ?? "—";

      document.getElementById("label-watching").textContent = isAnime ? "Watching" : "Reading";
      document.getElementById("label-plan").textContent = isAnime ? "Plan to Watch" : "Plan to Read";

      document.getElementById("stat-watching").textContent =
        isAnime ? stats.watching ?? "—"
                : stats.reading ?? "—";

      document.getElementById("stat-completed").textContent = stats.completed ?? "—";
      document.getElementById("stat-onhold").textContent    = stats.on_hold ?? "—";
      document.getElementById("stat-dropped").textContent   = stats.dropped ?? "—";
      document.getElementById("stat-plan").textContent =
        isAnime ? stats.plan_to_watch ?? "—"
                : stats.plan_to_read ?? "—";

      document.getElementById("stat-total").textContent = stats.total_entries ?? "—";

      document.getElementById("stat-rewatch").textContent =
        isAnime ? stats.rewatched ?? "—"
                : stats.reread ?? "—";

      document.getElementById("rewatch-row").childNodes[0].textContent =
        isAnime ? "Rewatched " : "Reread ";

      // Anime: show episodes in row 3 right, hide chapters/volumes
      // Manga: hide episodes (keep placeholder div), show chapters in row 3 right, volumes in row 4 right
      document.getElementById("extra-episodes").style.display = isAnime ? "" : "none";
      document.getElementById("extra-chapters").style.display = isAnime ? "none" : "";
      document.getElementById("extra-volumes").style.display  = isAnime ? "none" : "";
      document.getElementById("extra-volumes-placeholder").style.display = isAnime ? "" : "none";

      document.getElementById("stat-episodes").textContent =
        stats.episodes_watched ?? "—";

      document.getElementById("stat-chapters").textContent =
        stats.chapters_read ?? "—";

      document.getElementById("stat-volumes").textContent =
        stats.volumes_read ?? "—";

      animateBars(stats, isAnime);

      // JIKAN updates
      const updates = isAnime
        ? data.updates.anime
        : data.updates.manga;

      document.getElementById("updates-label").textContent =
        isAnime ? "Recent Anime Updates" : "Recent Manga Updates";

      renderUpdates(updates || [], isAnime);

      // Favorites
      const favorites = isAnime
        ? data.favorites.anime
        : data.favorites.manga;

      if (!isAnime && !(favorites && favorites.length)) {
        clearInterval(autoSlide);
        document.getElementById("carousel-track").innerHTML =
          `<img src="icantread.jpg" alt="" style="width:100%;display:block;border-radius:3px;">`;
      } else {
        buildCarousel(favorites || []);
      }

      document.getElementById("carousel-label").textContent =
        isAnime ? "Anime Favorites" : "Manga Favorites";

      fadeSections.forEach(el => el.classList.remove("fading"));

    }, 220);

    localStorage.setItem("malWidgetMode", mode);
  }

  // ---- Init ----
  const savedMode = localStorage.getItem("malWidgetMode") || "anime";
  toggle.checked  = savedMode === "anime";
  render(savedMode);

  toggle.addEventListener("change", () => {
    render(toggle.checked ? "anime" : "manga");
  });

})();
</script>

</body>

</html>
